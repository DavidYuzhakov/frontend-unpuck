<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–¢–µ—Å—Ç Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)</h1>
        
        <div>
            <button onclick="testTelegramAuth()">–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testTelegramAuth() {
            try {
                log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
                const tg = window.Telegram?.WebApp;
                if (!tg) {
                    log('‚ùå Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω', 'error');
                    return;
                }
                
                log('‚úÖ Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                log(`üîç initData: ${tg.initData}`);
                log(`üîç initDataUnsafe: ${JSON.stringify(tg.initDataUnsafe)}`);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let userData = null;
                
                if (tg.initDataUnsafe?.user) {
                    userData = tg.initDataUnsafe.user;
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ initDataUnsafe', 'success');
                } else if (tg.user) {
                    userData = tg.user;
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ tg.user', 'success');
                } else {
                    log('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                    return;
                }
                
                log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${JSON.stringify(userData)}`);
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º payload
                const payload = {
                    telegramId: String(userData.id),
                    firstName: userData.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    lastName: userData.last_name || undefined,
                    username: userData.username || undefined,
                    photoUrl: userData.photo_url || undefined,
                };
                
                log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ${JSON.stringify(payload)}`);
                log(`üîó URL –∑–∞–ø—Ä–æ—Å–∞: ${API_BASE}/auth/telegram`);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                const response = await fetch(`${API_BASE}/auth/telegram`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                log(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Å—Ç–∞—Ç—É—Å: ${response.status}, –æ—Ç–≤–µ—Ç: ${errorText}`, 'error');
                    return;
                }
                
                const data = await response.json();
                log(`‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram: ${JSON.stringify(data)}`, 'success');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                if (data.token) {
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('auth_user', JSON.stringify(data.user));
                    log('üíæ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage', 'success');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`‚ùå –¢–∏–ø –æ—à–∏–±–∫–∏: ${typeof error}`, 'error');
                log(`‚ùå –°—Ç–µ–∫ –æ—à–∏–±–∫–∏: ${error.stack || '–ù–µ—Ç —Å—Ç–µ–∫–∞'}`, 'error');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            log(`üåê API_BASE: ${API_BASE}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
            const tg = window.Telegram?.WebApp;
            if (tg) {
                log('‚úÖ Telegram WebApp –≥–æ—Ç–æ–≤');
                tg.ready();
                tg.expand();
            } else {
                log('‚ö†Ô∏è Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω - —Ç–µ—Å—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
            }
        });
    </script>
</body>
</html>
